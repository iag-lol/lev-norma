<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inspección - Red Movilidad</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>

        /* Variables y configuración base */
:root {
    /* Colores base */
    --primary: #007bff;
    --primary-dark: #0056b3;
    --primary-light: #e8f0fe;
    --secondary: #6c757d;
    --success: #28a745;
    --success-pastel: #4ade80;
    --danger: #dc3545;
    --danger-pastel: #f87171;
    --warning: #ffc107;
    --warning-pastel: #fcd34d;
    --info: #17a2b8;
    --white: #ffffff;
    --light: #f8f9fa;
    --light-gray: #e9ecef;
    --gray: #adb5bd;
    --dark-gray: #495057;
    --dark: #212529;
    --border-radius: 12px;
    --border-radius-sm: 6px;
    --box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    --box-shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.15);
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji';
}

/* Tema Oscuro */
[data-theme="dark"] {
    --primary: #3b82f6;
    --primary-dark: #1d4ed8;
    --primary-light: #1e293b;
    --secondary: #94a3b8;
    --success: #10b981;
    --success-pastel: #065f46;
    --danger: #ef4444;
    --danger-pastel: #7f1d1d;
    --warning: #f59e0b;
    --warning-pastel: #78350f;
    --info: #06b6d4;
    --white: #0f172a;
    --light: #1e293b;
    --light-gray: #334155;
    --gray: #64748b;
    --dark-gray: #94a3b8;
    --dark: #f1f5f9;
    --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.6);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: var(--font-family);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    background-color: var(--light);
    color: var(--dark);
    line-height: 1.6;
    font-size: 16px;
    transition: var(--transition);
}

/* Contenedor principal */
.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
}

/* Botón para cambiar tema */
.theme-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--box-shadow);
    z-index: 100;
    border: none;
    transition: var(--transition);
}

.theme-toggle:hover {
    transform: scale(1.1);
    background-color: var(--primary-dark);
}

/* Header y barra de navegación */
.header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 1.25rem 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--box-shadow);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0;
    letter-spacing: -0.5px;
}

.status-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 8px 16px;
    border-radius: 20px;
    transition: var(--transition);
}

.status-dot {
    height: 10px;
    width: 10px;
    border-radius: 50%;
    transition: var(--transition);
}

.connected {
    background-color: var(--success);
    box-shadow: 0 0 6px var(--success);
}

.disconnected {
    background-color: var(--danger);
    box-shadow: 0 0 6px var(--danger);
}

/* Barra de contadores */
.counters-bar {
    background-color: var(--white);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 14px 0;
    border-bottom: 1px solid var(--light-gray);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: var(--transition);
}

.counters-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.counter-item {
    text-align: center;
    padding: 0.5rem 1rem;
    min-width: 120px;
    transition: var(--transition);
}

.counter-value {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: block;
    line-height: 1;
    letter-spacing: -1px;
    transition: var(--transition);
}

.counter-label {
    font-size: 0.85rem;
    color: var(--secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: var(--transition);
}

.ready {
    color: var(--success);
}

.pending {
    color: var(--warning);
}

/* Tabs de navegación */
.tabs-container {
    background-color: var(--white);
    border-bottom: 1px solid var(--light-gray);
    margin-bottom: 1.5rem;
    position: sticky;
    top: 70px;
    z-index: 900;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: var(--transition);
}

.tabs {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.tabs::-webkit-scrollbar {
    display: none;
}

.tab {
    padding: 16px 20px;
    white-space: nowrap;
    font-weight: 500;
    color: var(--secondary);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-align: center;
    flex: 1;
    max-width: 200px;
    min-width: 120px;
}

.tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background-color: transparent;
    transition: var(--transition);
}

.tab.active {
    color: var(--primary);
    font-weight: 600;
}

.tab.active::after {
    background-color: var(--primary);
}

.tab:hover {
    color: var(--primary);
}

/* Contenido principal */
.content {
    padding: 1rem 0 2rem;
    transition: var(--transition);
}

.page {
    display: none;
    animation: fadeIn 0.3s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Tarjetas */
.card {
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 1.5rem;
    overflow: hidden;
    transition: var(--transition);
    border: 1px solid var(--light-gray);
}

.card-header {
    padding: 1.25rem 1.5rem;
    background-color: var(--white);
    border-bottom: 1px solid var(--light-gray);
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
}

.card-body {
    padding: 1.5rem;
    transition: var(--transition);
}

/* Formularios */
.form-group {
    margin-bottom: 1.25rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--dark-gray);
    transition: var(--transition);
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    font-size: 1rem;
    transition: var(--transition);
    background-color: var(--white);
    color: var(--dark);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
}

.form-control[readonly] {
    background-color: var(--light);
    cursor: not-allowed;
}

/* Listas desplegables mejoradas */
select.form-control {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 8.825L1.175 4 2.05 3.125 6 7.075 9.95 3.125 10.825 4 6 8.825z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 12px;
    padding-right: 2.5rem;
}

.form-row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
}

.form-col {
    padding: 0 10px;
    flex: 1;
    min-width: 250px;
}


/* Secciones de normas - Versión optimizada */
.norm-section {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--dark-gray);
    padding-bottom: 0.4rem;
    border-bottom: 1px solid var(--light-gray);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.section-title::after {
    content: '';
    display: block;
    width: 2rem;
    height: 3px;
    background-color: var(--primary);
    border-radius: 2px;
}

.norm-grid {
    display: grid;
    gap: 0.75rem;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
}

/* Ajustes responsivos para la cuadrícula de normas */
@media (max-width: 480px) {
    .norm-grid {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 481px) and (max-width: 768px) {
    .norm-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
}

@media (min-width: 769px) and (max-width: 1200px) {
    .norm-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
}

@media (min-width: 1201px) {
    .norm-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
}

.norm-item {
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    padding: 0.75rem;
    transition: var(--transition);
    background-color: var(--white);
    position: relative;
    overflow: hidden;
}

.norm-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.norm-item.unanswered {
    border-color: var(--danger-pastel);
    box-shadow: 0 0 0 1px var(--danger-pastel);
}

.norm-item.unanswered::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--danger-pastel);
}

.norm-item.answered {
    border-color: var(--success-pastel);
    box-shadow: 0 0 0 1px var(--success-pastel);
}

.norm-item.answered::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--success-pastel);
}

.norm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    min-height: 28px;
}

.norm-title {
    font-weight: 500;
    margin-right: 0.5rem;
    transition: var(--transition);
    font-size: 0.9rem;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.norm-actions {
    display: flex;
    gap: 0.25rem;
    margin-left: auto;
    flex-shrink: 0;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--primary);
    font-size: 0.9rem;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    background-color: var(--primary-light);
    padding: 0;
}

.btn-icon:hover {
    transform: scale(1.1);
    background-color: var(--primary);
    color: white;
}

/* Opciones de estado (rediseñadas y más compactas) */
.status-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.4rem;
}

@media (min-width: 340px) {
    .status-options {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (min-width: 769px) and (max-width: 992px) {
    .status-options {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 993px) {
    .status-options {
        grid-template-columns: repeat(4, 1fr);
    }
}

.status-option {
    padding: 0.4rem 0.3rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--white);
    color: var(--dark);
    position: relative;
    overflow: hidden;
    height: 28px;
}

.status-option:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Estilos específicos por tipo de estado */
.status-option[data-status="Instalada"] {
    border-left: 3px solid var(--success-pastel);
}

.status-option[data-status="Pendiente"] {
    border-left: 3px solid var(--danger-pastel);
}

.status-option[data-status="Dañada"] {
    border-left: 3px solid var(--warning-pastel);
}

.status-option[data-status="No Corresponde"] {
    border-left: 3px solid var(--gray);
}

.status-option[data-status="Instalada"].selected {
    background-color: var(--success-pastel);
    color: white;
    border-color: var(--success-pastel);
    font-weight: 500;
}

.status-option[data-status="Pendiente"].selected {
    background-color: var(--danger-pastel);
    color: white;
    border-color: var(--danger-pastel);
    font-weight: 500;
}

.status-option[data-status="Dañada"].selected {
    background-color: var(--warning-pastel);
    color: white;
    border-color: var(--warning-pastel);
    font-weight: 500;
}

.status-option[data-status="No Corresponde"].selected {
    background-color: var(--gray);
    color: white;
    border-color: var(--gray);
    font-weight: 500;
    text-decoration: line-through;
    text-decoration-color: var(--danger);
    text-decoration-thickness: 2px;
}




/* Opciones de estado (rediseñadas y horizontales) */
.status-options {
    display: flex;
    gap: 0.5rem;
    justify-content: space-between;
}

.status-option {
    flex: 1;
    padding: 0.6rem 0.5rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.70rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--white);
    color: var(--dark);
    position: relative;
    overflow: hidden;
}

.status-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}

/* Estilos específicos por tipo de estado */
.status-option[data-status="Instalada"].selected {
    background-color: var(--success-pastel);
    color: white;
    border-color: var(--success-pastel);
    font-weight: 500;
}

.status-option[data-status="Pendiente"].selected {
    background-color: var(--danger-pastel);
    color: white;
    border-color: var(--danger-pastel);
    font-weight: 500;
}

.status-option[data-status="Dañada"].selected {
    background-color: var(--warning-pastel);
    color: white;
    border-color: var(--warning-pastel);
    font-weight: 500;
}

.status-option[data-status="No Corresponde"].selected {
    font-size: 0.2px;
    background-color: var(--gray);
    color: white;
    border-color: var(--gray);
    font-weight: 500;
    text-decoration: line-through;
    text-decoration-color: var(--danger);
    text-decoration-thickness: 2px;
}

/* Botones */
.btn {
    display: inline-block;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: var(--border-radius-sm);
    transition: var(--transition);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0) 100%
    );
    transition: all 0.6s;
}

.btn:hover::before {
    left: 100%;
}

.btn-block {
    display: block;
    width: 100%;
}

.btn-primary {
    color: #fff;
    background-color: var(--primary);
    border-color: var(--primary);
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    border-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}

.btn-outline-primary {
    color: var(--primary);
    background-color: transparent;
    border-color: var(--primary);
}

.btn-outline-primary:hover {
    color: #fff;
    background-color: var(--primary);
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}

/* Botones de acción en línea horizontal */
.action-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.action-buttons .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    flex: 1;
}

/* Barra de búsqueda mejorada */
.search-bar {
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
}

.search-bar .form-control {
    flex: 1;
}

/* Tablas mejoradas */
.table-container {
    overflow-x: auto;
    margin-bottom: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

.table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background-color: var(--white);
}

.table th,
.table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--light-gray);
    transition: var(--transition);
}

.table th {
    background-color: var(--light);
    font-weight: 500;
    color: var(--dark-gray);
    position: sticky;
    top: 0;
    z-index: 10;
}

.table th:first-child {
    border-top-left-radius: var(--border-radius);
}

.table th:last-child {
    border-top-right-radius: var(--border-radius);
}

.table tr:last-child td:first-child {
    border-bottom-left-radius: var(--border-radius);
}

.table tr:last-child td:last-child {
    border-bottom-right-radius: var(--border-radius);
}

.table tr:last-child td {
    border-bottom: none;
}

.table tr:hover {
    background-color: var(--light);
}

.table tr:hover td {
    transform: translateY(-1px);
}

/* Badges mejorados */
.badge {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.badge-success {
    background-color: var(--success-pastel);
    color: white;
}

.badge-warning {
    background-color: var(--warning-pastel);
    color: white;
}

.badge-danger {
    background-color: var(--danger-pastel);
    color: white;
}

.badge-info {
    background-color: var(--info);
    color: white;
}

/* Estado vacío */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray);
    transition: var(--transition);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--light-gray);
    transition: var(--transition);
}

.empty-state-message {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: var(--dark-gray);
    transition: var(--transition);
}

.empty-state-description {
    max-width: 500px;
    margin: 0 auto;
    transition: var(--transition);
}

/* Elementos de lista de buses */
.bus-list {
    list-style: none;
}

.bus-item {
    background-color: var(--white);
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
    cursor: pointer;
    border: 1px solid var(--light-gray);
}

.bus-item:hover {
    transform: translateY(-3px);
    box-shadow: var(--box-shadow-hover);
}

.bus-info {
    flex: 1;
}

.bus-ppu {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
    transition: var(--transition);
}

.bus-details {
    color: var(--gray);
    font-size: 0.9rem;
    transition: var(--transition);
}

/* Modal mejorado */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 2000;
    animation: fadeIn 0.2s ease;
}

.modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
    max-width: 90%;
    width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    z-index: 2001;
    animation: modalSlideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    transition: var(--transition);
}

@keyframes modalSlideIn {
    from {
        transform: translate(-50%, -60%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, -50%);
        opacity: 1;
    }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    transition: var(--transition);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
    transition: var(--transition);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--danger);
    background-color: var(--light);
    transform: rotate(90deg);
}

.modal-body {
    padding: 1.5rem;
    transition: var(--transition);
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--light-gray);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    transition: var(--transition);
}

/* Cargador más elegante */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 3000;
}

.loader-spinner {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: conic-gradient(transparent 0%, rgba(var(--primary-rgb), 0.1) 50%, var(--primary) 100%);
    position: relative;
    animation: rotate 1s linear infinite;
}

.loader-spinner::before {
    content: '';
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
    border-radius: 50%;
    background-color: var(--white);
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Toast mejorado */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    background-color: var(--white);
    color: var(--dark);
    border-radius: var(--border-radius);
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
    z-index: 3000;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transform: translateX(150%);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    max-width: 350px;
    width: 100%;
}

.toast.show {
    transform: translateX(0);
}

.toast-success {
    border-left: 4px solid var(--success);
}

.toast-error {
    border-left: 4px solid var(--danger);
}

.toast-info {
    border-left: 4px solid var(--primary);
}

.toast-icon {
    font-size: 1.5rem;
}

.toast-success .toast-icon {
    color: var(--success);
}

.toast-error .toast-icon {
    color: var(--danger);
}

.toast-info .toast-icon {
    color: var(--primary);
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    transition: var(--transition);
}

.toast-message {
    font-size: 0.9rem;
    color: var(--gray);
    transition: var(--transition);
}

.toast-close {
    background: none;
    border: none;
    color: var(--gray);
    cursor: pointer;
    font-size: 1.25rem;
    transition: var(--transition);
}

.toast-close:hover {
    color: var(--danger);
    transform: rotate(90deg);
}

/* Responsive design mejorado */
@media (max-width: 768px) {
    .header h1 {
        font-size: 1.5rem;
    }

    .form-row {
        flex-direction: column;
    }

    .form-col {
        width: 100%;
    }

    .norm-grid {
        grid-template-columns: 1fr;
    }

    .action-buttons {
        flex-wrap: wrap;
    }

    .modal {
        width: 95%;
    }
    
    .tab {
        padding: 12px 15px;
        font-size: 0.9rem;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .norm-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1025px) {
    .norm-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* Ajustes para teclado móvil */
@media (max-height: 500px) and (max-width: 768px) {
    .header {
        position: relative;
    }
    
    .tabs-container {
        top: 0;
    }
}

/* Animaciones y efectos interactivos */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.pulse {
    animation: pulse 2s infinite;
}

/* Efectos hover para interactividad */
.card:hover {
    transform: translateY(-5px);
    box-shadow: var(--box-shadow-hover);
}

.btn:active, .status-option:active {
    transform: scale(0.98);
}

/* Código para agregar a tu HTML para el botón de tema */
/*
<button id="theme-toggle" class="theme-toggle">
    <i class="fas fa-moon"></i>
</button>

<script>
    // Agregar al final de tu archivo JavaScript
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    
    // Verificar si hay un tema guardado o usar la preferencia del sistema
    const currentTheme = localStorage.getItem('theme') || 
                         (prefersDarkScheme.matches ? 'dark' : 'light');
    
    // Aplicar tema inicial
    if (currentTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        themeIcon.classList.replace('fa-moon', 'fa-sun');
    }
    
    // Cambiar tema al hacer clic
    themeToggle.addEventListener('click', () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        
        if (isDark) {
            document.body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
        } else {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }
    });
</script>
*/

    </style>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>Levantamiento Nueva Norma</h1>
                <div class="status-container">
                    <div class="status-dot connected" id="status-dot"></div>
                    <span id="status-text">Conectado a Supabase</span>
                </div>
            </div>
        </div>
    </header>

    <div class="counters-bar">
        <div class="container">
            <div class="counters-container">
                <div class="counter-item">
                    <span class="counter-value ready" id="completed-count">0</span>
                    <span class="counter-label">Buses Listos</span>
                </div>
                <div class="counter-item">
                    <span class="counter-value pending" id="pending-count">0</span>
                    <span class="counter-label">Buses Pendientes</span>
                </div>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="container">
            <div class="tabs">
                <div class="tab active" data-tab="form">Formulario</div>
                <div class="tab" data-tab="history">Histórico</div>
                <div class="tab" data-tab="complete">Buses Completos</div>
                <div class="tab" data-tab="pending">Buses Pendientes</div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="container">
            <!-- FORM PAGE -->
            <div class="page active" id="form-page">
                <div class="card">
                    <div class="card-header">
                        Formulario de Inspección
                    </div>
                    <div class="card-body">
                        <form id="inspection-form">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="ppu">PPU (Patente)</label>
                                        <input type="text" class="form-control" id="ppu" name="ppu" required
                                            placeholder="Ingrese patente" list="ppu-list">
                                        <datalist id="ppu-list"></datalist>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="terminal">Terminal</label>
                                        <select class="form-control" id="terminal" name="terminal" required>
                                            <option value="">Seleccione Terminal</option>
                                            <option value="EL ROBLE">EL ROBLE</option>
                                            <option value="LA REINA">LA REINA</option>
                                            <option value="MARIA ANGELICA">MARIA ANGELICA</option>
                                            <option value="EL DESCANSO">EL DESCANSO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="clase">Clase</label>
                                        <input type="text" class="form-control" id="clase" name="clase" readonly>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="marca">Marca</label>
                                        <input type="text" class="form-control" id="marca" name="marca" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="norm-section">
                                <h3 class="section-title">Lista de Normas Gráficas</h3>
                                <div class="norm-grid" id="norms-container">
                                    <!-- Norms will be added here dynamically -->
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="fecha">Fecha y Hora</label>
                                <input type="text" class="form-control" id="fecha" name="fecha" readonly>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block">Registrar Inspección</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- HISTORY PAGE -->
            <div class="page" id="history-page">
                <div class="card">
                    <div class="card-header">
                        Histórico de Revisiones
                    </div>
                    <div class="card-body">
                        <div class="search-bar">
                            <input type="text" class="form-control" placeholder="Buscar por patente"
                                id="history-search">
                            <select class="form-control" id="history-filter">
                                <option value="all">Todos</option>
                                <option value="completed">Completos</option>
                                <option value="pending">Pendientes</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <table class="table" id="history-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>PPU</th>
                                        <th>Terminal</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="history-list">
                                    <!-- History items will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <div id="history-empty" class="empty-state" style="display: none;">
                            <div class="empty-state-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <h3 class="empty-state-message">No hay registros de inspección</h3>
                            <p class="empty-state-description">Las inspecciones realizadas aparecerán aquí.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPLETE BUSES PAGE -->
            <div class="page" id="complete-page">
                <div class="card">
                    <div class="card-header">
                        Buses Completos
                    </div>
                    <div class="card-body">
                        <div class="search-bar">
                            <input type="text" class="form-control" placeholder="Buscar por patente"
                                id="complete-search">
                            <select class="form-control" id="complete-filter">
                                <option value="all">Todas las marcas</option>
                                <option value="Scania">Scania</option>
                                <option value="Volvo">Volvo</option>
                            </select>
                        </div>

                        <ul class="bus-list" id="complete-buses-list">
                            <!-- Complete buses will be added here dynamically -->
                        </ul>

                        <div id="complete-empty" class="empty-state" style="display: none;">
                            <div class="empty-state-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 class="empty-state-message">No hay buses completos</h3>
                            <p class="empty-state-description">Los buses que tengan todas las normas instaladas o
                                marcadas como "No corresponde" aparecerán aquí.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PENDING BUSES PAGE -->
            <div class="page" id="pending-page">
                <div class="card">
                    <div class="card-header">
                        Buses Pendientes
                    </div>
                    <div class="card-body">
                        <div class="action-buttons">
                            <button class="btn btn-outline-primary" id="export-pdf">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button class="btn btn-outline-primary" id="export-excel">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                        </div>

                        <div class="search-bar">
                            <input type="text" class="form-control" placeholder="Buscar por patente"
                                id="pending-search">
                            <select class="form-control" id="pending-filter">
                                <option value="all">Todas las normas</option>
                                <option value="class-b">Clase B</option>
                                <option value="class-c">Clase C</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <table class="table" id="pending-table">
                                <thead>
                                    <tr>
                                        <th>PPU</th>
                                        <th>Clase</th>
                                        <th>Norma Pendiente</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-list">
                                    <!-- Pending items will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <div id="pending-empty" class="empty-state" style="display: none;">
                            <div class="empty-state-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 class="empty-state-message">No hay buses pendientes</h3>
                            <p class="empty-state-description">Los buses con normas pendientes o dañadas aparecerán
                                aquí.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FOR BUS DETAILS -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="detail-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Detalles del Bus</h3>
                <button type="button" class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be added dynamically -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="modal-close-btn">Cerrar</button>
                <button type="button" class="btn btn-primary" id="modal-edit-btn">Editar</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fas fa-check-circle" id="toast-icon"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toast-title">Éxito</div>
            <div class="toast-message" id="toast-message">Operación completada exitosamente.</div>
        </div>
        <button class="toast-close" id="toast-close">&times;</button>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loader-spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>

    <script>

        // Configuración de Supabase
        const SUPABASE_URL = 'https://tcmtxvuucjttngcazgff.supabase.co';  // Reemplazar con tu URL de Supabase
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0';  // Reemplazar con tu API key pública
        let supabaseClient = null;

        // Estado de la aplicación
        let currentBusData = null;
        let inspectionData = [];
        let isEditMode = false;
        let editInspectionIndex = -1;
        let isConnected = false;

        // Opciones de estado para normas
        const statusOptions = ["Instalada", "Pendiente", "Dañada", "No Corresponde"];

        // Inicializar Supabase al cargar la página
        document.addEventListener("DOMContentLoaded", async function () {
            try {
                // Inicializar cliente Supabase
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // Verificar conexión
                const { data, error } = await supabaseClient.from('inspecciones').select('count');

                if (error) throw error;

                // Marcar como conectado si no hay error
                isConnected = true;
                updateConnectionStatus(true);
                showToast('success', 'Conexión Exitosa', 'Conectado correctamente a la base de datos');

                // Inicializar aplicación
                initializeApp();
            } catch (error) {
                console.error('Error al conectar con Supabase:', error);
                isConnected = false;
                updateConnectionStatus(false);
                showToast('error', 'Error de Conexión', 'No se pudo conectar a la base de datos. Trabajando en modo local.');

                // Inicializar aplicación en modo offline
                initializeApp();
            }
        });

        // Inicializar la aplicación
        function initializeApp() {
            populatePPUDatalist();
            updateDateTimeField();
            setInterval(updateDateTimeField, 60000);
            initializeTabSystem();
            initializeForm();
            initializeModals();
            initializeFilters();
            initializeExportButtons();

            // Cargar datos iniciales
            loadInspectionData();

            // Verificar conexión periódicamente
            setInterval(checkConnection, 30000);
        }

        // Verificar conexión a Supabase
        async function checkConnection() {
            try {
                if (!supabaseClient) return;

                const { data, error } = await supabaseClient.from('inspecciones').select('count');

                if (error) throw error;

                // Si estábamos desconectados y ahora conectados, recargar datos
                if (!isConnected) {
                    isConnected = true;
                    updateConnectionStatus(true);
                    showToast('success', 'Conexión Restablecida', 'La conexión a la base de datos ha sido restablecida');
                    loadInspectionData();
                } else {
                    isConnected = true;
                }
            } catch (error) {
                if (isConnected) {
                    isConnected = false;
                    updateConnectionStatus(false);
                    showToast('error', 'Conexión Perdida', 'Se ha perdido la conexión a la base de datos. Trabajando en modo local.');
                }
            }
        }

        // Actualizar indicador de estado de conexión
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Conectado a Supabase';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Desconectado';
            }
        }

        // Modificar esta función de fecha para guardar dos formatos
function updateDateTimeField() {
    const now = new Date();
    // Formato para mostrar al usuario
    const formattedDateForDisplay = now.toLocaleString('es-CL');
    // Formato ISO para Supabase
    const formattedDateForDB = now.toISOString();
    
    // Mostrar formato legible para el usuario
    document.getElementById('fecha').value = formattedDateForDisplay;
    // Guardar formato ISO como un atributo de datos
    document.getElementById('fecha').setAttribute('data-iso-date', formattedDateForDB);
}

// Modificar la función saveInspection para usar el formato ISO
async function saveInspection(data) {
    if (isConnected && supabaseClient) {
        try {
            // Obtener la fecha en formato ISO en lugar del formato localizado
            const isoDate = document.getElementById('fecha').getAttribute('data-iso-date') || new Date().toISOString();
            
            // 1. Guardar inspección principal
            const { data: inspectionData, error: inspectionError } = await supabaseClient
                .from('inspecciones')
                .insert({
                    ppu: data.ppu,
                    terminal: data.terminal,
                    clase: data.clase,
                    marca: data.marca,
                    fecha: isoDate // ¡Usar formato ISO aquí!
                })
                .select()
                .single();

            if (inspectionError) throw inspectionError;
            
            // 2. Guardar detalles de normas
            const normPromises = data.norms.map(norm => {
                return supabaseClient
                    .from('normas_inspeccion')
                    .insert({
                        inspeccion_id: inspectionData.id,
                        titulo: norm.title,
                        estado: norm.status
                    });
            });
            
            await Promise.all(normPromises);
            
            // Actualizar datos en memoria
            await loadInspectionData();
            
        } catch (error) {
            console.error('Error al guardar en Supabase:', error);
            throw error;
        }
    } else {
        // Modo offline: Guardar en localStorage...
        // (El resto de tu código para modo offline queda igual)
    }
}

// También actualiza la función updateInspection
async function updateInspection(data, index) {
    if (isConnected && supabaseClient) {
        try {
            // Obtener la fecha en formato ISO
            const isoDate = document.getElementById('fecha').getAttribute('data-iso-date') || new Date().toISOString();
            
            // Obtener ID de la inspección
            const { data: existingData, error: fetchError } = await supabaseClient
                .from('inspecciones')
                .select('id')
                .eq('ppu', data.ppu)
                .single();
                
            if (fetchError) throw fetchError;
            
            // Actualizar inspección principal
            const { error: updateError } = await supabaseClient
                .from('inspecciones')
                .update({
                    terminal: data.terminal,
                    clase: data.clase,
                    marca: data.marca,
                    fecha: isoDate // ¡Usar formato ISO aquí!
                })
                .eq('id', existingData.id);
                
            if (updateError) throw updateError;
            
            // El resto de tu función updateInspection sigue igual...
            
        } catch (error) {
            console.error('Error al actualizar en Supabase:', error);
            throw error;
        }
    } else {
        // Modo offline: Actualizar en localStorage...
        // (El resto de tu código para modo offline queda igual)
    }
}

        // Poblar el datalist de PPU para autocompletado
        function populatePPUDatalist() {
            const datalist = document.getElementById('ppu-list');
            fleetData.forEach(bus => {
                const option = document.createElement('option');
                option.value = bus.ppu;
                datalist.appendChild(option);
            });
        }

        // Inicializar sistema de pestañas
        function initializeTabSystem() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Quitar clase active de todas las pestañas y páginas
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

                    // Añadir clase active a la pestaña clickeada
                    tab.classList.add('active');

                    // Mostrar página correspondiente
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId + '-page').classList.add('active');
                });
            });
        }

        // Función para obtener la fecha y hora actual formateada
function updateDateTimeField() {
    const now = new Date();
    // Formato para mostrar al usuario (y guardar en la BD como texto)
    const formattedDate = now.toLocaleString('es-CL');
    document.getElementById('fecha').value = formattedDate;
}

// Guardar inspección (ahora guarda la fecha como texto directamente)
async function saveInspection(data) {
    if (isConnected && supabaseClient) {
        try {
            // 1. Guardar inspección principal con fecha como texto
            const { data: inspectionData, error: inspectionError } = await supabaseClient
                .from('inspecciones')
                .insert({
                    ppu: data.ppu,
                    terminal: data.terminal,
                    clase: data.clase,
                    marca: data.marca,
                    fecha: data.fecha // Guardamos directamente el texto de la fecha
                })
                .select()
                .single();

            if (inspectionError) throw inspectionError;
            
            // 2. Guardar detalles de normas
            const normPromises = data.norms.map(norm => {
                return supabaseClient
                    .from('normas_inspeccion')
                    .insert({
                        inspeccion_id: inspectionData.id,
                        titulo: norm.title,
                        estado: norm.status
                    });
            });
            
            await Promise.all(normPromises);
            
            // Actualizar datos en memoria
            await loadInspectionData();
            
        } catch (error) {
            console.error('Error al guardar en Supabase:', error);
            throw error;
        }
    } else {
        // Modo offline: Guardar en localStorage
        // (el resto de tu código para modo offline queda igual)
    }
}

        // Inicializar funcionalidad del formulario
        function initializeForm() {
            const ppuInput = document.getElementById('ppu');
            ppuInput.addEventListener('input', function () {
                const ppu = this.value.toUpperCase();
                const bus = fleetData.find(b => b.ppu === ppu);

                if (bus) {
                    document.getElementById('clase').value = bus.clase;
                    document.getElementById('marca').value = bus.marca;
                    currentBusData = bus;

                    // Si no estamos en modo edición y se selecciona un bus, intentar cargar datos previos
                    if (!isEditMode) {
                        populateNorms();

                        // Buscar inspecciones previas del bus
                        checkExistingInspection(ppu);
                    }
                } else {
                    document.getElementById('clase').value = '';
                    document.getElementById('marca').value = '';
                    currentBusData = null;
                    clearNorms();
                }
            });

            // Envío del formulario
            document.getElementById('inspection-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                if (!currentBusData) {
                    showToast('error', 'Error', 'Por favor ingrese una patente válida');
                    return;
                }

                // Verificar que todas las normas han sido respondidas
                const unansweredNorms = document.querySelectorAll('.norm-item.unanswered');
                if (unansweredNorms.length > 0) {
                    showToast('error', 'Formulario Incompleto', 'Por favor complete todas las normas antes de enviar');

                    // Scroll a la primera norma sin responder
                    unansweredNorms[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                const formData = {
                    ppu: document.getElementById('ppu').value.toUpperCase(),
                    terminal: document.getElementById('terminal').value,
                    clase: document.getElementById('clase').value,
                    marca: document.getElementById('marca').value,
                    fecha: document.getElementById('fecha').value,
                    norms: []
                };

                // Recopilar estado de las normas
                document.querySelectorAll('.norm-item').forEach(normItem => {
                    const normTitle = normItem.querySelector('.norm-title').textContent;
                    const selectedOption = normItem.querySelector('.status-option.selected');
                    const status = selectedOption ? selectedOption.getAttribute('data-status') : null;

                    if (status) {
                        formData.norms.push({
                            title: normTitle,
                            status: status
                        });
                    }
                });

                // Mostrar indicador de carga
                document.getElementById('loading-overlay').style.display = 'flex';

                try {
                    // Guardar o actualizar datos de la inspección
                    if (isEditMode && editInspectionIndex >= 0) {
                        await updateInspection(formData, editInspectionIndex);
                        showToast('success', 'Datos Actualizados', 'La inspección se ha actualizado correctamente');
                    } else {
                        await saveInspection(formData);
                        showToast('success', 'Inspección Registrada', 'La inspección se ha registrado correctamente');
                    }

                    // Resetear formulario y estado
                    document.getElementById('inspection-form').reset();
                    clearNorms();
                    currentBusData = null;
                    isEditMode = false;
                    editInspectionIndex = -1;

                    // Actualizar UI
                    await loadInspectionData();
                    updateCounters();
                } catch (error) {
                    console.error('Error al guardar la inspección:', error);
                    showToast('error', 'Error', 'Ocurrió un problema al guardar la inspección. Inténtelo nuevamente.');
                } finally {
                    // Ocultar indicador de carga
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            });
        }

        // Verificar si existe una inspección previa
        async function checkExistingInspection(ppu) {
            try {
                let existingInspection = null;

                if (isConnected && supabaseClient) {
                    // Buscar en Supabase
                    const { data, error } = await supabaseClient
                        .from('inspecciones')
                        .select('*')
                        .eq('ppu', ppu)
                        .order('fecha', { ascending: false })
                        .limit(1);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        existingInspection = data[0];
                    }
                } else {
                    // Buscar en datos locales
                    const busInspections = inspectionData.filter(insp => insp.ppu === ppu);
                    if (busInspections.length > 0) {
                        existingInspection = busInspections[0];
                    }
                }

                // Si encontramos una inspección existente
                if (existingInspection) {
                    showToast('info', 'Bus con Inspección Previa', 'Este bus ya ha sido inspeccionado. ¿Desea editar los datos existentes?', () => {
                        // Cargar datos existentes para edición
                        loadExistingInspection(ppu);
                    });
                }
            } catch (error) {
                console.error('Error al verificar inspección existente:', error);
            }
        }

        // Inicializar modales
        function initializeModals() {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalClose = document.getElementById('modal-close');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalEditBtn = document.getElementById('modal-edit-btn');

            // Cerrar modal al hacer clic en el botón de cierre
            modalClose.addEventListener('click', closeModal);
            modalCloseBtn.addEventListener('click', closeModal);

            // Cerrar modal al hacer clic fuera
            modalOverlay.addEventListener('click', function (e) {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });

            // Funcionalidad del botón de edición
            modalEditBtn.addEventListener('click', function () {
                const ppu = document.getElementById('modal-title').textContent.split(':')[1].trim();
                loadExistingInspection(ppu);
                closeModal();

                // Cambiar a la pestaña del formulario
                document.querySelector('.tab[data-tab="form"]').click();
            });
        }

        // Inicializar filtros
        function initializeFilters() {
            // Filtros del historial
            document.getElementById('history-search').addEventListener('input', function () {
                updateHistoryList();
            });

            document.getElementById('history-filter').addEventListener('change', function () {
                updateHistoryList();
            });

            // Filtros de buses completos
            document.getElementById('complete-search').addEventListener('input', function () {
                updateCompleteList();
            });

            document.getElementById('complete-filter').addEventListener('change', function () {
                updateCompleteList();
            });

            // Filtros de buses pendientes
            document.getElementById('pending-search').addEventListener('input', function () {
                updatePendingList();
            });

            document.getElementById('pending-filter').addEventListener('change', function () {
                updatePendingList();
            });
        }

        // Inicializar botones de exportación
        function initializeExportButtons() {
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
        }

        // Exportar a PDF
        function exportToPDF() {
            // Verificar si hay buses pendientes
            const pendingBuses = getPendingBuses();
            if (pendingBuses.length === 0) {
                showToast('error', 'Sin Datos', 'No hay buses pendientes para exportar');
                return;
            }

            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Configurar título
            doc.setFontSize(16);
            doc.setTextColor(40, 40, 40);
            doc.text('Reporte de Buses Pendientes', 105, 15, { align: 'center' });

            // Agregar fecha
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-CL')}`, 105, 22, { align: 'center' });

            // Preparar datos de la tabla
            const tableHeaders = [['PPU', 'Clase', 'Norma Pendiente', 'Estado']];
            const tableData = pendingBuses.map(item => [
                item.ppu,
                item.clase,
                item.normTitle,
                item.status
            ]);

            // Generar tabla
            doc.autoTable({
                head: tableHeaders,
                body: tableData,
                startY: 30,
                headStyles: { fillColor: [26, 115, 232], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 30 }
            });

            // Guardar PDF
            doc.save('buses-pendientes.pdf');

            showToast('success', 'PDF Generado', 'El archivo PDF se ha descargado correctamente');
        }



// Ocultar indicador de carga
const loadingOverlay = document.getElementById('loading-overlay');
if (loadingOverlay) {
    loadingOverlay.style.display = 'none';
}

        // Exportar a Excel
        function exportToExcel() {
            // Verificar si hay buses pendientes
            const pendingBuses = getPendingBuses();
            if (pendingBuses.length === 0) {
                showToast('error', 'Sin Datos', 'No hay buses pendientes para exportar');
                return;
            }

            // Preparar datos
            const data = [
                ['PPU', 'Clase', 'Marca', 'Terminal', 'Norma Pendiente', 'Estado']
            ];

            pendingBuses.forEach(item => {
                // Buscar terminal
                const busInspection = inspectionData.find(insp => insp.ppu === item.ppu);
                const terminal = busInspection ? busInspection.terminal : '';

                data.push([
                    item.ppu,
                    item.clase,
                    item.marca,
                    terminal,
                    item.normTitle,
                    item.status
                ]);
            });

            // Crear libro de trabajo
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Buses Pendientes');

            // Establecer anchos de columna
            const wscols = [
                { wch: 10 },  // PPU
                { wch: 10 },  // Clase
                { wch: 10 },  // Marca
                { wch: 15 },  // Terminal
                { wch: 40 },  // Norma
                { wch: 15 }   // Estado
            ];
            ws['!cols'] = wscols;

            // Guardar archivo
            XLSX.writeFile(wb, 'buses-pendientes.xlsx');

            showToast('success', 'Excel Generado', 'El archivo Excel se ha descargado correctamente');
        }

        // Poblar normas en el formulario
        function populateNorms() {
            const normsContainer = document.getElementById('norms-container');
            normsContainer.innerHTML = '';

            graphicsNorms.forEach((norm, index) => {
                const normItem = document.createElement('div');
                normItem.className = 'norm-item unanswered';
                normItem.setAttribute('data-norm-index', index);
                normItem.innerHTML = `
            <div class="norm-header">
                <div class="norm-title">${norm.title}</div>
                <div class="norm-actions">
                    <button type="button" class="btn-icon" title="Ver descripción">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            <div class="status-options">
                ${statusOptions.map(option =>
                    `<div class="status-option" data-status="${option}">${option}</div>`
                ).join('')}
            </div>
        `;
                normsContainer.appendChild(normItem);

                // Agregar funcionalidad al botón de información
                const infoBtn = normItem.querySelector('.btn-icon');
                infoBtn.addEventListener('click', function () {
                    showToast('info', norm.title, norm.description);
                });
            });

            // Agregar funcionalidad de selección a las opciones de estado
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', function () {
                    // Quitar clase selected de hermanos
                    const siblings = this.parentElement.querySelectorAll('.status-option');
                    siblings.forEach(sib => sib.classList.remove('selected'));

                    // Agregar clase selected a la opción clickeada
                    this.classList.add('selected');

                    // Actualizar clase del elemento norm-item
                    const normItem = this.closest('.norm-item');
                    normItem.classList.remove('unanswered');
                    normItem.classList.add('answered');
                });
            });
        }

        // Limpiar contenedor de normas
        function clearNorms() {
            document.getElementById('norms-container').innerHTML = '';
        }

        // Actualizar campo de fecha y hora
        function updateDateTimeField() {
            const now = new Date();
            const formattedDate = now.toLocaleString('es-CL');
            document.getElementById('fecha').value = formattedDate;
        }

        // Guardar datos de inspección
        async function saveInspection(data) {
            if (isConnected && supabaseClient) {
                try {
                    // 1. Guardar inspección principal
                    const { data: inspectionData, error: inspectionError } = await supabaseClient
                        .from('inspecciones')
                        .insert({
                            ppu: data.ppu,
                            terminal: data.terminal,
                            clase: data.clase,
                            marca: data.marca,
                            fecha: data.fecha
                        })
                        .select()
                        .single();

                    if (inspectionError) throw inspectionError;

                    // 2. Guardar detalles de normas
                    const normPromises = data.norms.map(norm => {
                        return supabaseClient
                            .from('normas_inspeccion')
                            .insert({
                                inspeccion_id: inspectionData.id,
                                titulo: norm.title,
                                estado: norm.status
                            });
                    });

                    await Promise.all(normPromises);

                    // Actualizar datos en memoria
                    await loadInspectionData();

                } catch (error) {
                    console.error('Error al guardar en Supabase:', error);
                    throw error;
                }
            } else {
                // Modo offline: Guardar en localStorage

                // Comprobar si ya existe un registro para este bus
                const existingIndex = inspectionData.findIndex(insp => insp.ppu === data.ppu);

                if (existingIndex >= 0) {
                    // Actualizar registro existente
                    inspectionData[existingIndex] = data;
                } else {
                    // Agregar nuevo registro
                    inspectionData.push(data);
                }

                // Guardar en localStorage
                localStorage.setItem('inspections', JSON.stringify(inspectionData));
            }
        }

        // Actualizar inspección existente
        async function updateInspection(data, index) {
            if (isConnected && supabaseClient) {
                try {
                    // Obtener ID de la inspección
                    const { data: existingData, error: fetchError } = await supabaseClient
                        .from('inspecciones')
                        .select('id')
                        .eq('ppu', data.ppu)
                        .single();

                    if (fetchError) throw fetchError;

                    // Actualizar inspección principal
                    const { error: updateError } = await supabaseClient
                        .from('inspecciones')
                        .update({
                            terminal: data.terminal,
                            clase: data.clase,
                            marca: data.marca,
                            fecha: data.fecha
                        })
                        .eq('id', existingData.id);

                    if (updateError) throw updateError;

                    // Eliminar normas existentes
                    const { error: deleteError } = await supabaseClient
                        .from('normas_inspeccion')
                        .delete()
                        .eq('inspeccion_id', existingData.id);

                    if (deleteError) throw deleteError;

                    // Insertar nuevas normas
                    const normPromises = data.norms.map(norm => {
                        return supabaseClient
                            .from('normas_inspeccion')
                            .insert({
                                inspeccion_id: existingData.id,
                                titulo: norm.title,
                                estado: norm.status
                            });
                    });

                    await Promise.all(normPromises);

                    // Actualizar datos en memoria
                    await loadInspectionData();

                } catch (error) {
                    console.error('Error al actualizar en Supabase:', error);
                    throw error;
                }
            } else {
                // Modo offline: Actualizar en localStorage
                inspectionData[index] = data;
                localStorage.setItem('inspections', JSON.stringify(inspectionData));
            }
        }

        // Cargar datos de inspección
        async function loadInspectionData() {
            if (isConnected && supabaseClient) {
                try {
                    // 1. Obtener inspecciones
                    const { data: inspections, error: inspectionsError } = await supabaseClient
                        .from('inspecciones')
                        .select('*')
                        .order('fecha', { ascending: false });

                    if (inspectionsError) throw inspectionsError;

                    // 2. Obtener normas para cada inspección
                    const inspectionsWithNorms = await Promise.all(
                        inspections.map(async (inspection) => {
                            const { data: norms, error: normsError } = await supabaseClient
                                .from('normas_inspeccion')
                                .select('*')
                                .eq('inspeccion_id', inspection.id);

                            if (normsError) throw normsError;

                            return {
                                ...inspection,
                                norms: norms.map(n => ({
                                    title: n.titulo,
                                    status: n.estado
                                }))
                            };
                        })
                    );

                    // Actualizar datos en memoria
                    inspectionData = inspectionsWithNorms;

                } catch (error) {
                    console.error('Error al cargar datos de Supabase:', error);
                    // Si falla, intentar cargar desde localStorage
                    loadFromLocalStorage();
                    throw error;
                }
            } else {
                // Modo offline: Cargar desde localStorage
                loadFromLocalStorage();
            }

            // Actualizar UI
            updateHistoryList();
            updateCompleteList();
            updatePendingList();
            updateCounters();
        }

        // Cargar datos desde localStorage
        function loadFromLocalStorage() {
            const inspections = JSON.parse(localStorage.getItem('inspections') || '[]');
            inspectionData = inspections;
        }

        // Actualizar lista del historial
        function updateHistoryList() {
            const historyList = document.getElementById('history-list');
            const emptyState = document.getElementById('history-empty');
            const searchTerm = document.getElementById('history-search').value.toLowerCase();
            const filterValue = document.getElementById('history-filter').value;

            // Aplicar filtros
            let filteredInspections = inspectionData;

            if (searchTerm) {
                filteredInspections = filteredInspections.filter(insp =>
                    insp.ppu.toLowerCase().includes(searchTerm)
                );
            }

            if (filterValue !== 'all') {
                filteredInspections = filteredInspections.filter(insp => {
                    const pendingNorms = insp.norms.filter(norm =>
                        norm.status === 'Pendiente' || norm.status === 'Dañada'
                    );

                    if (filterValue === 'completed') {
                        return pendingNorms.length === 0;
                    } else {
                        return pendingNorms.length > 0;
                    }
                });
            }

            // Mostrar estado vacío si no hay inspecciones
            if (filteredInspections.length === 0) {
                historyList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            // Ocultar estado vacío y actualizar lista
            emptyState.style.display = 'none';
            historyList.innerHTML = '';

            filteredInspections.forEach((inspection, index) => {
                const pendingNorms = inspection.norms.filter(norm =>
                    norm.status === 'Pendiente' || norm.status === 'Dañada'
                ).length;

                const status = pendingNorms > 0 ? 'Pendiente' : 'Completo';
                const statusClass = status === 'Completo' ? 'badge-success' : 'badge-warning';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${inspection.fecha}</td>
            <td>${inspection.ppu}</td>
            <td>${inspection.terminal}</td>
            <td><span class="badge ${statusClass}">${status}</span></td>
            <td>
                <button class="btn-icon view-inspection" data-index="${index}" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon edit-inspection" data-index="${index}" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
                historyList.appendChild(row);
            });

            // Agregar event listeners para botones de ver y editar
            document.querySelectorAll('.view-inspection').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = this.getAttribute('data-index');
                    showInspectionDetails(inspectionData[index]);
                });
            });

            document.querySelectorAll('.edit-inspection').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = this.getAttribute('data-index');
                    loadExistingInspection(inspectionData[index].ppu);

                    // Cambiar a pestaña de formulario
                    document.querySelector('.tab[data-tab="form"]').click();
                });
            });
        }

        // Actualizar lista de buses completos
        function updateCompleteList() {
            const completeList = document.getElementById('complete-buses-list');
            const emptyState = document.getElementById('complete-empty');
            const searchTerm = document.getElementById('complete-search').value.toLowerCase();
            const filterValue = document.getElementById('complete-filter').value;

            // Obtener buses completos
            const completeBuses = getCompleteBuses();

            // Aplicar filtros
            let filteredBuses = completeBuses;

            if (searchTerm) {
                filteredBuses = filteredBuses.filter(bus =>
                    bus.ppu.toLowerCase().includes(searchTerm)
                );
            }

            if (filterValue !== 'all') {
                filteredBuses = filteredBuses.filter(bus => bus.marca === filterValue);
            }

            // Mostrar estado vacío si no hay buses
            if (filteredBuses.length === 0) {
                completeList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            // Ocultar estado vacío y actualizar lista
            emptyState.style.display = 'none';
            completeList.innerHTML = '';

            filteredBuses.forEach(bus => {
                const busItem = document.createElement('li');
                busItem.className = 'bus-item';
                busItem.setAttribute('data-ppu', bus.ppu);
                busItem.innerHTML = `
            <div class="bus-info">
                <div class="bus-ppu">${bus.ppu}</div>
                <div class="bus-details">${bus.marca} | Clase ${bus.clase} | ${bus.terminal}</div>
            </div>
            <span class="badge badge-success">Completo</span>
        `;
                completeList.appendChild(busItem);

                // Agregar evento de clic para mostrar detalles
                busItem.addEventListener('click', function () {
                    const ppu = this.getAttribute('data-ppu');
                    const busInspection = inspectionData.find(insp => insp.ppu === ppu);
                    if (busInspection) {
                        showInspectionDetails(busInspection);
                    }
                });
            });
        }

        // Actualizar lista de buses pendientes
        function updatePendingList() {
            const pendingList = document.getElementById('pending-list');
            const emptyState = document.getElementById('pending-empty');
            const searchTerm = document.getElementById('pending-search').value.toLowerCase();
            const filterValue = document.getElementById('pending-filter').value;

            // Obtener buses pendientes
            const pendingBuses = getPendingBuses();

            // Aplicar filtros
            let filteredBuses = pendingBuses;

            if (searchTerm) {
                filteredBuses = filteredBuses.filter(bus =>
                    bus.ppu.toLowerCase().includes(searchTerm)
                );
            }

            if (filterValue !== 'all') {
                filteredBuses = filteredBuses.filter(bus => {
                    if (filterValue === 'class-b') {
                        return bus.clase === 'B';
                    } else if (filterValue === 'class-c') {
                        return bus.clase === 'C';
                    }
                    return true;
                });
            }

            // Mostrar estado vacío si no hay buses
            if (filteredBuses.length === 0) {
                pendingList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            // Ocultar estado vacío y actualizar lista
            emptyState.style.display = 'none';
            pendingList.innerHTML = '';

            filteredBuses.forEach(item => {
                const statusClass = item.status === 'Pendiente' ? 'badge-warning' : 'badge-danger';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${item.ppu}</td>
            <td>${item.clase}</td>
            <td>${item.normTitle}</td>
            <td><span class="badge ${statusClass}">${item.status}</span></td>
            <td>
                <button class="btn-icon view-bus" data-ppu="${item.ppu}" title="Ver detalles">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
                pendingList.appendChild(row);
            });

            // Agregar event listeners para botones de ver
            document.querySelectorAll('.view-bus').forEach(btn => {
                btn.addEventListener('click', function () {
                    const ppu = this.getAttribute('data-ppu');
                    const busInspection = inspectionData.find(insp => insp.ppu === ppu);
                    if (busInspection) {
                        showInspectionDetails(busInspection);
                    }
                });
            });
        }

        // Obtener buses completos
        function getCompleteBuses() {
            // Obtener buses únicos
            const allBuses = new Set(inspectionData.map(inspection => inspection.ppu));
            const completeBuses = [];

            allBuses.forEach(ppu => {
                // Obtener la inspección más reciente para este bus
                const busInspections = inspectionData.filter(inspection => inspection.ppu === ppu);

                if (busInspections.length > 0) {
                    // Ordenar por fecha más reciente
                    busInspections.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                    const latestInspection = busInspections[0];
                    const pendingNorms = latestInspection.norms.filter(norm =>
                        norm.status === 'Pendiente' || norm.status === 'Dañada'
                    );

                    if (pendingNorms.length === 0) {
                        completeBuses.push(latestInspection);
                    }
                }
            });

            return completeBuses;
        }

        // Obtener buses pendientes
        function getPendingBuses() {
            // Obtener buses únicos con normas pendientes
            const pendingItems = [];

            // Crear un Set para almacenar PPUs únicas
            const processedBuses = new Set();

            // Ordenar inspecciones por fecha (más reciente primero)
            const sortedInspections = [...inspectionData].sort((a, b) =>
                new Date(b.fecha) - new Date(a.fecha)
            );

            sortedInspections.forEach(inspection => {
                // Si ya procesamos este bus, saltarlo
                if (processedBuses.has(inspection.ppu)) return;

                const pendingNorms = inspection.norms.filter(norm =>
                    norm.status === 'Pendiente' || norm.status === 'Dañada'
                );

                if (pendingNorms.length > 0) {
                    pendingNorms.forEach(norm => {
                        pendingItems.push({
                            ppu: inspection.ppu,
                            clase: inspection.clase,
                            marca: inspection.marca,
                            terminal: inspection.terminal,
                            normTitle: norm.title,
                            status: norm.status
                        });
                    });

                    // Marcar este bus como procesado
                    processedBuses.add(inspection.ppu);
                }
            });

            return pendingItems;
        }

        // Actualizar contadores
        function updateCounters() {
            const completeBuses = getCompleteBuses().length;
            const pendingBuses = new Set(getPendingBuses().map(item => item.ppu)).size;

            // Actualizar contadores en UI
            document.getElementById('completed-count').textContent = completeBuses;
            document.getElementById('pending-count').textContent = pendingBuses;
        }

        // Mostrar detalles de inspección en modal
        function showInspectionDetails(inspection) {
            document.getElementById('modal-title').textContent = `Bus: ${inspection.ppu}`;

            let content = `
        <div style="margin-bottom: 20px;">
            <div style="margin-bottom: 10px;"><strong>Terminal:</strong> ${inspection.terminal}</div>
            <div style="margin-bottom: 10px;"><strong>Clase:</strong> ${inspection.clase}</div>
            <div style="margin-bottom: 10px;"><strong>Marca:</strong> ${inspection.marca}</div>
            <div style="margin-bottom: 10px;"><strong>Fecha de inspección:</strong> ${inspection.fecha}</div>
        </div>
        
        <h4 style="margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #ddd;">Estado de Normas Gráficas</h4>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
    `;

            // Agrupar normas por estado
            const installedNorms = inspection.norms.filter(norm => norm.status === 'Instalada');
            const pendingNorms = inspection.norms.filter(norm => norm.status === 'Pendiente');
            const damagedNorms = inspection.norms.filter(norm => norm.status === 'Dañada');
            const notApplicableNorms = inspection.norms.filter(norm => norm.status === 'No Corresponde');

            // Agregar badges de estado a cada norma
            inspection.norms.forEach(norm => {
                let statusClass;
                switch (norm.status) {
                    case 'Instalada':
                        statusClass = 'badge-success';
                        break;
                    case 'Pendiente':
                        statusClass = 'badge-warning';
                        break;
                    case 'Dañada':
                        statusClass = 'badge-danger';
                        break;
                    case 'No Corresponde':
                        statusClass = 'badge-info';
                        break;
                }

                content += `
            <div style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <div style="font-weight: 500; margin-bottom: 5px;">${norm.title}</div>
                <span class="badge ${statusClass}" style="display: inline-block;">${norm.status}</span>
            </div>
        `;
            });

            content += `</div>`;

            // Agregar sección de resumen
            content += `
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
            <h4 style="margin-bottom: 15px;">Resumen</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div style="flex: 1; min-width: 120px; padding: 10px; background-color: #e6f4ea; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 600; color: #0f9d58;">${installedNorms.length}</div>
                    <div style="font-size: 0.9rem; color: #5f6368;">Instaladas</div>
                </div>
                <div style="flex: 1; min-width: 120px; padding: 10px; background-color: #fef7e0; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 600; color: #f29900;">${pendingNorms.length}</div>
                    <div style="font-size: 0.9rem; color: #5f6368;">Pendientes</div>
                </div>
                <div style="flex: 1; min-width: 120px; padding: 10px; background-color: #fce8e6; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 600; color: #d93025;">${damagedNorms.length}</div>
                    <div style="font-size: 0.9rem; color: #5f6368;">Dañadas</div>
                </div>
                <div style="flex: 1; min-width: 120px; padding: 10px; background-color: #e8f4fd; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 600; color: #1aa3ff;">${notApplicableNorms.length}</div>
                    <div style="font-size: 0.9rem; color: #5f6368;">No Aplica</div>
                </div>
            </div>
        </div>
    `;

            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').style.display = 'block';
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // Mostrar notificación toast
        function showToast(type, title, message, callback) {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            // Establecer contenido
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            // Establecer tipo
            toast.className = 'toast';
            if (type === 'success') {
                toast.classList.add('toast-success');
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toast.classList.add('toast-error');
                toastIcon.className = 'fas fa-exclamation-circle';
            } else if (type === 'info') {
                toast.classList.add('toast-info');
                toastIcon.className = 'fas fa-info-circle';
            }

            // Mostrar toast
            toast.classList.add('show');

            // Agregar callback de clic si se proporciona
            if (callback) {
                toast.addEventListener('click', function toastClickHandler() {
                    callback();
                    toast.removeEventListener('click', toastClickHandler);
                }, { once: true });
            }

            // Cerrar toast después de 5 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);

            // Cerrar al hacer clic
            document.getElementById('toast-close').addEventListener('click', function () {
                toast.classList.remove('show');
            });
        }

        // Cargar datos de inspección existente para edición
        function loadExistingInspection(ppu) {
            const inspection = inspectionData.find(insp => insp.ppu === ppu);
            if (!inspection) return;

            // Establecer modo edición
            isEditMode = true;
            editInspectionIndex = inspectionData.indexOf(inspection);

            // Llenar campos del formulario
            document.getElementById('ppu').value = inspection.ppu;
            document.getElementById('terminal').value = inspection.terminal;
            document.getElementById('clase').value = inspection.clase;
            document.getElementById('marca').value = inspection.marca;

            // Obtener datos del bus
            currentBusData = fleetData.find(bus => bus.ppu === inspection.ppu);

            // Poblar normas
            populateNorms();

            // Marcar estado existente para cada norma
            setTimeout(() => {
                document.querySelectorAll('.norm-item').forEach(normItem => {
                    const normTitle = normItem.querySelector('.norm-title').textContent;
                    const norm = inspection.norms.find(n => n.title === normTitle);

                    if (norm) {
                        // Encontrar y seleccionar la opción de estado correspondiente
                        const statusOption = normItem.querySelector(`.status-option[data-status="${norm.status}"]`);
                        if (statusOption) {
                            statusOption.click();
                        }
                    }
                });
            }, 100);
        }

        // Datos de la flota completos
        const fleetData = [
            { ppu: "LXWP57", marca: "Scania", clase: "B" },
            { ppu: "LXWP58", marca: "Scania", clase: "C" },
            { ppu: "LXWP59", marca: "Scania", clase: "C" },
            { ppu: "LXWP60", marca: "Scania", clase: "C" },
            { ppu: "LXWP61", marca: "Scania", clase: "B" },
            { ppu: "LXWP62", marca: "Scania", clase: "B" },
            { ppu: "LXWP64", marca: "Scania", clase: "C" },
            { ppu: "LXWP65", marca: "Scania", clase: "C" },
            { ppu: "LXWP66", marca: "Scania", clase: "B" },
            { ppu: "LXWP67", marca: "Scania", clase: "B" },
            { ppu: "LXWP68", marca: "Scania", clase: "B" },
            { ppu: "LXWP69", marca: "Scania", clase: "B" },
            { ppu: "LXWP70", marca: "Scania", clase: "B" },
            { ppu: "LXWP71", marca: "Scania", clase: "B" },
            { ppu: "LXWP72", marca: "Scania", clase: "B" },
            { ppu: "LXWP73", marca: "Scania", clase: "B" },
            { ppu: "LXWP74", marca: "Scania", clase: "B" },
            { ppu: "LXWP75", marca: "Scania", clase: "B" },
            { ppu: "LXWP76", marca: "Scania", clase: "B" },
            { ppu: "LXWP77", marca: "Scania", clase: "B" },
            { ppu: "LXWP78", marca: "Scania", clase: "B" },
            { ppu: "LXWP79", marca: "Scania", clase: "B" },
            { ppu: "LXWP80", marca: "Scania", clase: "B" },
            { ppu: "LXWP81", marca: "Scania", clase: "B" },
            { ppu: "LXWP82", marca: "Scania", clase: "B" },
            { ppu: "LXWP83", marca: "Scania", clase: "B" },
            { ppu: "LXWP85", marca: "Scania", clase: "B" },
            { ppu: "LXWP86", marca: "Scania", clase: "B" },
            { ppu: "LXWP87", marca: "Scania", clase: "C" },
            { ppu: "PFTV77", marca: "Scania", clase: "B" },
            { ppu: "PFTW19", marca: "Scania", clase: "C" },
            { ppu: "PFTW20", marca: "Scania", clase: "C" },
            { ppu: "PFTW25", marca: "Scania", clase: "C" },
            { ppu: "PFTW26", marca: "Scania", clase: "C" },
            { ppu: "PFTW28", marca: "Scania", clase: "B" },
            { ppu: "PFTW29", marca: "Scania", clase: "B" },
            { ppu: "PFTW30", marca: "Scania", clase: "B" },
            { ppu: "PFTW31", marca: "Scania", clase: "B" },
            { ppu: "PFTW32", marca: "Scania", clase: "B" },
            { ppu: "PFTW34", marca: "Scania", clase: "B" },
            { ppu: "PFTW35", marca: "Scania", clase: "C" },
            { ppu: "PFTW36", marca: "Scania", clase: "B" },
            { ppu: "PFTW38", marca: "Scania", clase: "B" },
            { ppu: "PFTW39", marca: "Scania", clase: "C" },
            { ppu: "PFTW40", marca: "Scania", clase: "B" },
            { ppu: "PFTW41", marca: "Scania", clase: "C" },
            { ppu: "PFTW42", marca: "Scania", clase: "C" },
            { ppu: "PFTW44", marca: "Scania", clase: "B" },
            { ppu: "PFTW45", marca: "Scania", clase: "B" },
            { ppu: "PFTW46", marca: "Scania", clase: "B" },
            { ppu: "PFTW47", marca: "Scania", clase: "B" },
            { ppu: "PFTW48", marca: "Scania", clase: "C" },
            { ppu: "PFTW49", marca: "Scania", clase: "B" },
            { ppu: "PFTW50", marca: "Scania", clase: "B" },
            { ppu: "PFTW51", marca: "Scania", clase: "C" },
            { ppu: "PFTW55", marca: "Scania", clase: "C" },
            { ppu: "PFTW56", marca: "Scania", clase: "B" },
            { ppu: "PFTW57", marca: "Scania", clase: "B" },
            { ppu: "PFTW58", marca: "Scania", clase: "B" },
            { ppu: "PFTW59", marca: "Scania", clase: "C" },
            { ppu: "PFTW60", marca: "Scania", clase: "C" },
            { ppu: "PFTW61", marca: "Scania", clase: "C" },
            { ppu: "PFTW62", marca: "Scania", clase: "C" },
            { ppu: "PFVG75", marca: "Scania", clase: "C" },
            { ppu: "PFVG76", marca: "Scania", clase: "C" },
            { ppu: "PFVG77", marca: "Scania", clase: "C" },
            { ppu: "PFVG78", marca: "Scania", clase: "B" },
            { ppu: "PFVG79", marca: "Scania", clase: "B" },
            { ppu: "PFVG80", marca: "Scania", clase: "B" },
            { ppu: "PFVG82", marca: "Scania", clase: "B" },
            { ppu: "PFVG83", marca: "Scania", clase: "B" },
            { ppu: "PFVG85", marca: "Scania", clase: "B" },
            { ppu: "PFVG86", marca: "Scania", clase: "B" },
            { ppu: "PFVG87", marca: "Scania", clase: "B" },
            { ppu: "PFVG88", marca: "Scania", clase: "B" },
            { ppu: "PFVG89", marca: "Scania", clase: "C" },
            { ppu: "PFVG90", marca: "Scania", clase: "C" },
            { ppu: "PFVG92", marca: "Scania", clase: "C" },
            { ppu: "PFVG93", marca: "Scania", clase: "C" },
            { ppu: "PFVG94", marca: "Scania", clase: "C" },
            { ppu: "PFVG95", marca: "Scania", clase: "C" },
            { ppu: "PFVG96", marca: "Scania", clase: "C" },
            { ppu: "PFVG97", marca: "Scania", clase: "B" },
            { ppu: "PFVG98", marca: "Scania", clase: "B" },
            { ppu: "PFVG99", marca: "Scania", clase: "B" },
            { ppu: "PFVH10", marca: "Scania", clase: "B" },
            { ppu: "PFVH11", marca: "Scania", clase: "B" },
            { ppu: "PFVH12", marca: "Scania", clase: "B" },
            { ppu: "PFVH13", marca: "Scania", clase: "B" },
            { ppu: "PFVH14", marca: "Scania", clase: "B" },
            { ppu: "PFVH15", marca: "Scania", clase: "B" },
            { ppu: "PFYC13", marca: "Scania", clase: "C" },
            { ppu: "PFYC14", marca: "Scania", clase: "C" },
            { ppu: "PFYC16", marca: "Scania", clase: "C" },
            { ppu: "PFYC17", marca: "Scania", clase: "C" },
            { ppu: "PFYC19", marca: "Scania", clase: "B" },
            { ppu: "PFYC20", marca: "Scania", clase: "B" },
            { ppu: "PFYC25", marca: "Scania", clase: "B" },
            { ppu: "PFYC26", marca: "Scania", clase: "C" },
            { ppu: "PFYC27", marca: "Scania", clase: "B" },
            { ppu: "PFYC28", marca: "Scania", clase: "B" },
            { ppu: "PFYC29", marca: "Scania", clase: "B" },
            { ppu: "PFYC31", marca: "Scania", clase: "B" },
            { ppu: "PFYC32", marca: "Scania", clase: "B" },
            { ppu: "PFYC33", marca: "Scania", clase: "B" },
            { ppu: "PFYC34", marca: "Scania", clase: "B" },
            { ppu: "PFYC35", marca: "Scania", clase: "B" },
            { ppu: "PFYC36", marca: "Scania", clase: "B" },
            { ppu: "PFYC37", marca: "Scania", clase: "C" },
            { ppu: "PFYC43", marca: "Scania", clase: "B" },
            { ppu: "PFYC44", marca: "Scania", clase: "B" },
            { ppu: "PFYC46", marca: "Scania", clase: "C" },
            { ppu: "PFYC49", marca: "Scania", clase: "B" },
            { ppu: "PFYC50", marca: "Scania", clase: "C" },
            { ppu: "PFYC53", marca: "Scania", clase: "B" },
            { ppu: "PFYC55", marca: "Scania", clase: "B" },
            { ppu: "PFYC57", marca: "Scania", clase: "B" },
            { ppu: "PFYC58", marca: "Scania", clase: "C" },
            { ppu: "PFYC59", marca: "Scania", clase: "C" },
            { ppu: "PFYC60", marca: "Scania", clase: "B" },
            { ppu: "PFYC61", marca: "Scania", clase: "C" },
            { ppu: "PFYC62", marca: "Scania", clase: "C" },
            { ppu: "PFYC63", marca: "Scania", clase: "C" },
            { ppu: "PFYC64", marca: "Scania", clase: "C" },
            { ppu: "PFYC65", marca: "Scania", clase: "B" },
            { ppu: "PFYC66", marca: "Scania", clase: "B" },
            { ppu: "PFYC68", marca: "Scania", clase: "C" },
            { ppu: "PFYC69", marca: "Scania", clase: "C" },
            { ppu: "PFYC70", marca: "Scania", clase: "C" },
            { ppu: "PFYC72", marca: "Scania", clase: "B" },
            { ppu: "PFYC75", marca: "Scania", clase: "B" },
            { ppu: "PFYC76", marca: "Scania", clase: "B" },
            { ppu: "PFYC77", marca: "Scania", clase: "B" },
            { ppu: "PFYC79", marca: "Scania", clase: "C" },
            { ppu: "PFYC80", marca: "Scania", clase: "C" },
            { ppu: "PFYC81", marca: "Scania", clase: "C" },
            { ppu: "PFYC82", marca: "Scania", clase: "C" },
            { ppu: "PFYC85", marca: "Scania", clase: "C" },
            { ppu: "PFYC88", marca: "Scania", clase: "B" },
            { ppu: "PFYC90", marca: "Scania", clase: "B" },
            { ppu: "PFZK83", marca: "Scania", clase: "C" },
            { ppu: "PFZK85", marca: "Scania", clase: "C" },
            { ppu: "PFZK87", marca: "Scania", clase: "C" },
            { ppu: "PFZK88", marca: "Scania", clase: "C" },
            { ppu: "PFZK91", marca: "Scania", clase: "C" },
            { ppu: "PGBF42", marca: "Scania", clase: "C" },
            { ppu: "PGBF59", marca: "Scania", clase: "C" },
            { ppu: "PGBY47", marca: "Scania", clase: "C" },
            { ppu: "PGBY52", marca: "Scania", clase: "C" },
            { ppu: "PGBY55", marca: "Scania", clase: "C" },
            { ppu: "PGBY56", marca: "Scania", clase: "C" },
            { ppu: "PGBY67", marca: "Scania", clase: "B" },
            { ppu: "PGBY72", marca: "Scania", clase: "C" },
            { ppu: "PGBY73", marca: "Scania", clase: "C" },
            { ppu: "PGBY83", marca: "Scania", clase: "C" },
            { ppu: "PGKP67", marca: "Scania", clase: "B" },
            { ppu: "PGLD42", marca: "Scania", clase: "B" },
            { ppu: "PGLD67", marca: "Scania", clase: "B" },
            { ppu: "PGLD68", marca: "Scania", clase: "C" },
            { ppu: "PGLD72", marca: "Scania", clase: "C" },
            { ppu: "PGRZ67", marca: "Scania", clase: "B" },
            { ppu: "PGTT95", marca: "Scania", clase: "B" },
            { ppu: "PGTV12", marca: "Scania", clase: "B" },
            { ppu: "PGWT98", marca: "Scania", clase: "B" },
            { ppu: "SHCV78", marca: "Volvo", clase: "B" },
            { ppu: "SHCX39", marca: "Volvo", clase: "B" },
            { ppu: "SHCY22", marca: "Volvo", clase: "B" },
            { ppu: "SHXD75", marca: "Volvo", clase: "B" },
            { ppu: "SHXD77", marca: "Volvo", clase: "B" },
            { ppu: "SHXD79", marca: "Volvo", clase: "B" },
            { ppu: "SHXD85", marca: "Volvo", clase: "B" },
            { ppu: "SHXF13", marca: "Volvo", clase: "B" },
            { ppu: "SHXF14", marca: "Volvo", clase: "B" },
            { ppu: "SHXF29", marca: "Volvo", clase: "B" },
            { ppu: "SHXF31", marca: "Volvo", clase: "B" },
            { ppu: "SHXF84", marca: "Volvo", clase: "B" },
            { ppu: "SHXF85", marca: "Volvo", clase: "B" },
            { ppu: "SHXF87", marca: "Volvo", clase: "B" },
            { ppu: "SHXF88", marca: "Volvo", clase: "B" },
            { ppu: "SHXF90", marca: "Volvo", clase: "B" },
            { ppu: "SHXF92", marca: "Volvo", clase: "B" },
            { ppu: "SHXF93", marca: "Volvo", clase: "B" },
            { ppu: "SHXF97", marca: "Volvo", clase: "B" },
            { ppu: "SHXG36", marca: "Volvo", clase: "B" },
            { ppu: "SHXG38", marca: "Volvo", clase: "B" },
            { ppu: "SJPB21", marca: "Volvo", clase: "B" },
            { ppu: "SJPD42", marca: "Volvo", clase: "B" },
            { ppu: "SJPD44", marca: "Volvo", clase: "B" },
            { ppu: "SJPD71", marca: "Volvo", clase: "B" },
            { ppu: "SJPD72", marca: "Volvo", clase: "B" },
            { ppu: "SKPJ54", marca: "Volvo", clase: "C" },
            { ppu: "SKPJ90", marca: "Volvo", clase: "B" },
            { ppu: "SKPK18", marca: "Volvo", clase: "B" },
            { ppu: "SKPK19", marca: "Volvo", clase: "B" },
            { ppu: "SKPK20", marca: "Volvo", clase: "B" },
            { ppu: "SKPK21", marca: "Volvo", clase: "B" },
            { ppu: "SKPK22", marca: "Volvo", clase: "B" },
            { ppu: "SKPK23", marca: "Volvo", clase: "B" },
            { ppu: "SKPK25", marca: "Volvo", clase: "B" },
            { ppu: "SKPK26", marca: "Volvo", clase: "B" },
            { ppu: "SKPK27", marca: "Volvo", clase: "B" },
            { ppu: "SKPK28", marca: "Volvo", clase: "B" },
            { ppu: "SKPK31", marca: "Volvo", clase: "B" },
            { ppu: "SKPK32", marca: "Volvo", clase: "B" },
            { ppu: "SKPK34", marca: "Volvo", clase: "B" },
            { ppu: "SKPK35", marca: "Volvo", clase: "B" },
            { ppu: "SKPK37", marca: "Volvo", clase: "B" },
            { ppu: "SKPK39", marca: "Volvo", clase: "B" },
            { ppu: "SKPK40", marca: "Volvo", clase: "B" },
            { ppu: "SKPK42", marca: "Volvo", clase: "B" },
            { ppu: "SKPK44", marca: "Volvo", clase: "B" },
            { ppu: "SKPK45", marca: "Volvo", clase: "B" },
            { ppu: "SKPK62", marca: "Volvo", clase: "B" },
            { ppu: "SKPK63", marca: "Volvo", clase: "B" },
            { ppu: "SKPL28", marca: "Volvo", clase: "B" },
            { ppu: "SKPL30", marca: "Volvo", clase: "B" },
            { ppu: "SKPL33", marca: "Volvo", clase: "B" },
            { ppu: "SKPL34", marca: "Volvo", clase: "B" },
            { ppu: "SKPL36", marca: "Volvo", clase: "B" }
        ];

        // Datos completos de normas gráficas
        const graphicsNorms = [
            { title: "CALL CENTER", description: "Información del call center." },
            { title: "CERO EMISION", description: "Indicador de bus con cero emisiones." },
            { title: "BUS ELECTRICO", description: "Señalización para buses eléctricos." },
            { title: "NUMERO INTERNO", description: "Número interno del bus." },
            { title: "SEÑAL SUBIDA Y BAJADA", description: "Señalización para indicar donde subir y bajar del bus." },
            { title: "ACCESO SILLA DE RUEDAS", description: "Señalización para acceso de sillas de ruedas." },
            { title: "VIRAJE AMPLIO", description: "Señalización de viraje amplio del vehículo." },
            { title: "MARCA CHILE", description: "Logo o marca Chile en el bus." },
            { title: "REFLECTANTE", description: "Elementos reflectantes en la carrocería." },
            { title: "ESPEJO PUNTO CIEGO", description: "Espejos para reducir puntos ciegos." },
            { title: "TRASERO", description: "Parte trasera del vehículo." },
            { title: "TRIANGULO PUNTO CIEGO", description: "Señalización triangular de puntos ciegos." },
            { title: "LOGO CLASE A Y B", description: "Logo que indica clase A y B del bus." },
            { title: "LOGO CLACE C", description: "Logo que indica clase C del bus." },
            { title: "NO SUBIR", description: "Señalización que indica prohibición de subir." },
            { title: "CUIDADO APERTURA Y CUERRE DE PUERTAS", description: "Advertencia sobre apertura y cierre de puertas." },
            { title: "NO TE APOYES", description: "Indicación de no apoyarse en ciertas áreas." },
            { title: "PUERTA PARA PERSONAS CON DISCAPACIDAD", description: "Señalización de puerta para personas con discapacidad." },
            { title: "NO ABRA LA VENTANA", description: "Indicación de no abrir ventanas." },
            { title: "RANGO DE TEMPERATURA", description: "Información sobre el rango de temperatura del aire acondicionado." },
            { title: "ESCAPE", description: "Señalización de salidas de escape." },
            { title: "INSTRUCCIÓN DE ESCAPE", description: "Instrucciones para usar salidas de emergencia." },
            { title: "ASIENTO PREFERENTE", description: "Señalización de asientos preferentes." },
            { title: "ACCESO WIFI", description: "Información sobre acceso a WiFi." },
            { title: "LOGO CAMARAS GRABANDO", description: "Aviso de cámaras de seguridad en funcionamiento." },
            { title: "ADHESIVO ADVERTENCIA FISCALIZACION", description: "Información sobre fiscalización." },
            { title: "ADHESIVO SUBETE AL BUS", description: "Promoción para uso del transporte público." },
            { title: "ADHESIVO NUMERO DE EMERGENCIA", description: "Número de contacto para emergencias." },
            { title: "COMO ACCIONAR FRENO DE MANO ELECTRICO", description: "Instrucciones para el freno de mano eléctrico." },
            { title: "COMO ACCIONAR FRENO DE MANO", description: "Instrucciones para el freno de mano." },
            { title: "PERRO DE ASISTENCIA", description: "Señalización sobre perros de asistencia." },
            { title: "NO FUMAR", description: "Prohibición de fumar." },
            { title: "PARADA NOCTURNA", description: "Información sobre paradas nocturnas." },
            { title: "SEÑAL PISO SILLA DE RUEDAS", description: "Señalización en el piso para ubicación de sillas de ruedas." },
            { title: "CUIDADO PELDAÑO", description: "Advertencia sobre peldaños en el bus." },
            { title: "ESPACIO RESERVADO", description: "Señalización de espacios reservados." },
            { title: "ASIENTO ABATIBLE", description: "Indicación de asientos abatibles." },
            { title: "USO PREFERENTE", description: "Señalización de áreas de uso preferente." },
            { title: "CENEFA", description: "Elemento decorativo tipo cenefa." },
            { title: "PPU", description: "Placa Patente Única visible." },
            { title: "SOAP", description: "Información del Seguro Obligatorio de Accidentes Personales." },
            { title: "CANAL DE DENUNCIAS", description: "Información sobre canales para denuncias." },
            { title: "BUENAS PRACTICAS", description: "Adhesivos sobre buenas prácticas para usuarios." }
        ];



    </script>
</body>

</html>